# Auth service

**Auth service** является сервисом для авторизации запросов к [golos.io](https://golos.io).
Для работы сервису необходим совместимый фасад-сервис, осуществляющий конечное общение с системой.

### Основное

Микросервис реализует два метода:

-   'auth.authorize': принимает параметр вида `{ user, sign, secret, ...data }` и возвращает данные вида `{...data, sign, user, roles: []}` либо ошибку авторизации. Авторизация происходит следующим образом: сначала проверяется, соответствует ли значение параметра `secret` тому, что уже хранится для этого `channelId`. Если да, то создается фейковая транзакция на основе параметров `secret`, `sign` и `user` и отправляется в блокчейн. Если блокчейн авторизует транзакцию, то значит, что данные авторизации верны. Иначе, будет возвращена ошибка авторизации.

-   'auth.generateSecret': принимает параметр вида `{ channelId }` и возвращает сгенерированный секрет. Секрет представляет собой строку, содержащую восьмиричный хеш `sha1`, рассчитанный для строки, состоящей из `channelId` и рандомной строки в качестве "соли"

### Фейковая транзакция

```
{
    ref_block_num: 3367,
    ref_block_prefix: 879276768,
    expiration: '2018-07-06T14:52:24',
    operations: [
        [
            'vote',
            {
                voter: <user>,      // Имя пользователя
                author: 'test',
                permlink: <secret>, // Секрет, который пришел в запросе с сервера
                weight: 1,
            },
        ],
    ],
    extensions: [],
}
```

##### API JSON-RPC

Описание принимаемых параметров:

| **Параметр** | **Тип** |                                          **Описание**                                          |
| :----------: | :-----: | :--------------------------------------------------------------------------------------------: |
|    `user`    | string  |                                        Имя пользователя                                        |
| `channelId`  | string  | Идентификатор канала передачи данных, указывающий, по какому каналу нужно будет передать ответ |
|   `secret`   | string  |                                       Секрет для подписи                                       |
|    `sign`    | string  |                                     Подпись для транзакции                                     |

### Переменные окружения

Возможные переменные окружения `ENV`:

-   `GLS_CONNECTOR_HOST` _(обязательно)_ - адрес, который будет использован для входящих подключений связи микросервисов.  
    Дефолтное значение при запуске без докера - `127.0.0.1`

-   `GLS_CONNECTOR_PORT` _(обязательно)_ - адрес порта, который будет использован для входящих подключений связи микросервисов.  
    Дефолтное значение при запуске без докера - `3000`, пересекается с `GLS_FRONTEND_GATE_PORT`

-   `GLS_METRICS_HOST` _(обязательно)_ - адрес хоста для метрик StatsD.  
    Дефолтное значение при запуске без докера - `127.0.0.1`

-   `GLS_METRICS_PORT` _(обязательно)_ - адрес порта для метрик StatsD.  
    Дефолтное значение при запуске без докера - `8125`

### Запуск

Для запуска достаточно вызвать команду `docker-compose up` в корне проекта, предварительно указав необходимые `ENV` переменные.
